// 引数のハッシュ値(SHA-256)を取得する関数（天野）function getHashCode(text){    var shaObj = new jsSHA("SHA-256", "TEXT", 1);    shaObj.update(text);    return shaObj.getHash("HEX");}// ランダム値の配列取得関数function getRandValues(opt, arr){    var originalArr = [];    var randValArr = [];    obj = {        size:1,        min:1,        max:100,        step:1    };    for(var i in obj){        if(opt && opt[i]!==undefined){            obj[i] = opt[i];        }    }    if( !(arr instanceof Array) || (arr.length===0)){        if(arr instanceof Array){            originalArr = arr;        }        for(var i=obj['min'],j=0; i<=obj['max']; i+=obj['step'],j++){            originalArr[j] = i;        }        arr = originalArr;    }else{        originalArr = arr;    }    var rand, getVal;    for(var i=0;i<obj['size'];i++){        rand = Math.floor( Math.random() * originalArr.length);        getVal = originalArr.splice(rand,1);        randValArr.push(getVal[0]);    }    return randValArr;}// スマホ判別var _ua = (function(u){  return {    Tablet:(u.indexOf("windows") != -1 && u.indexOf("touch") != -1 && u.indexOf("tablet pc") == -1)       || u.indexOf("ipad") != -1      || (u.indexOf("android") != -1 && u.indexOf("mobile") == -1)      || (u.indexOf("firefox") != -1 && u.indexOf("tablet") != -1)      || u.indexOf("kindle") != -1      || u.indexOf("silk") != -1      || u.indexOf("playbook") != -1,    Mobile:(u.indexOf("windows") != -1 && u.indexOf("phone") != -1)      || u.indexOf("iphone") != -1      || u.indexOf("ipod") != -1      || (u.indexOf("android") != -1 && u.indexOf("mobile") != -1)      || (u.indexOf("firefox") != -1 && u.indexOf("mobile") != -1)      || u.indexOf("blackberry") != -1  }})(window.navigator.userAgent.toLowerCase());$(function(){    var m_kind = $('#mainContent').data('content'); // どの種類のページか    $.getJSON('/eticket/review4/application.json', function(json){        // 見出しを更新        $('#menuUnitLogo h2').text(json.unit);        // どの種類のページかで関数分け        var funcs = {            'SoundFeatures' : funcSoundFeatures,            'DictationRep' : funcDictationRep,            'Vocabulary' : funcVocabulary,            'ToeicP1' : funcToeicPart1,            'ToeicP2' : funcToeicPart2,            'ToeicP3' : funcToeicPart3,            'ToeicP4' : funcToeicPart4        };        // スマホかタブレットならタップしないといけないようにする        if(_ua.Mobile || _ua.Tablet){            $('#mainContainer').css('background-image','none').append('<p class="mobile_tap">スマホやタブレットを使用している方はここをタップしてください</p>').click(function(){                $(this).off('click');                $('#mainContainer').css('background-image','');                $('.mobile_tap').remove();                loadingSound(json[m_kind].sounds, function(){                    funcCommon(json, m_kind);                    funcs[m_kind](json, json[m_kind]);                    $('#mainContainer').removeClass('loading');                },json.materialPath);            });        }else{            loadingSound(json[m_kind].sounds, function(){                funcCommon(json, m_kind);                funcs[m_kind](json, json[m_kind]);                $('#mainContainer').removeClass('loading');            },json.materialPath);        }    });    // オーディオオブジェクトを格納するオブジェクト    var audioObj = {};    // 指定の配列に入っている音声ファイルを順番に流す関数    var playList = new Array();    // audioList : 再生する音声ファイルのパス(配列なら複数)    // isParallel : 現在流れている音声を流したままにするかどうか    var soundRotation = function(audioList, isParallel){        console.log(audioList);        var defer = $.Deferred();   // $.Defferedオブジェクト        var playListLen = playList.length;        // 再生リストの停止        if (playListLen && !isParallel) {            // 現在の音声リストを調査            for (var i = 0; i < playListLen; ++i) {                // 再生中であれば停止                if(!playList[i].paused){                    playList[i].pause();                    playList[i].currentTime = 0;                }            }        }        // audioListが無ければ以降の処理はしない        if(!audioList){            return defer.promise();        }        // 変数が配列でないなら、配列化        if(typeof audioList === 'string'){            audioList = [audioList];        }        // 再生リストの作成        playList = new Array();        for (var i in audioList) {            playList[i] = audioObj[audioList[i]];        }        // 再生リストの連結        if (playList.length != 0) {            for (var i = 0, len = playList.length; i < len - 1; ++i) {                playList[i].addEventListener("ended", function(audio) { return function(){                    audio.play();                }; }(playList[i + 1]));            }            // 最後のイベント時にDefferedオブジェクトをresolveにする            playList[playList.length - 1].addEventListener("ended", function(){                defer.resolve();            })            // 先頭の音声を再生            playList[0].play();        }        return defer.promise(); // プロミスを作って返す    }    // 個別の音声を流す処理    function soundPiece($item){        console.dir($item.data());        var def = $.Deferred();        soundRotation($item.data('sound')).done(function(){            $item.removeClass('hover');            def.resolve();        })        return def.promise(); // プロミスを作って返す;    }    // 音声のローディング処理    function loadingSound(soundList, endedFunc, materialPath){        var loadedCnt = 0;        var soundLen = 0;        var loadedFunc = function(mp3){            loadedCnt++;            if(soundLen === loadedCnt){                endedFunc();            }        }        for(var prop in soundList){            var sl = soundList[prop];            for(var i = 0, len = sl.length; i < len; i++){                if(sl[i] === '') continue; // 中身が空なら飛ばす                soundLen++;                audioObj[sl[i]] = new Audio();                audioObj[sl[i]].autoplay = false;                $(audioObj[sl[i]]).on('loadedmetadata', loadedFunc);                $(audioObj[sl[i]]).on('error abort', function(){                    $('#mainContainer').html('<p style="font-weight:bold;margin:5px;">音声のロードでエラーが発生しました。再度更新してください</p>')                        .removeClass('loading');                });                audioObj[sl[i]].src = materialPath + sl[i];                audioObj[sl[i]].load();            }        }    }    // 各ページ共通の処理    function funcCommon(json, kind){        console.dir(json);        // 現在のページのタブにcurrentクラスを追加        $('#mainTopMenu li[data-page='+json.page+']').addClass('current');        // 画面表示時の音声を再生        soundRotation(json[kind].sounds.introSound);        // メインのヘッダ更新        $('#mainContent .contentItem').html(json['EnglishTitle'] + '<span>' + json['JapaneseTitle'] +'</span>');        $('#mainContent .contentStudy').html(json['study']);        $('#mainContent .mainContentHead').css('background-image','url('+ json['materialPath'] + json['iconImage'] +')');    }    // SOUND FEATURES用の関数    function funcSoundFeatures(json, app){        $('#mainContent .description').html(app.description);        // 個別の文章の処理        var sentences = app.sentences;        var $piece = $('#mainContent .sf-piece');        var coord = app.coordinate;        for( var i = 0, len = sentences.length; i < len; i++ ){            var sentence = sentences[i].replace(/{/g, '<span>').replace(/}/g, '</span>');            var pos = coord[i].split(',');            var $li = $('<li>').html(sentence);            // 音声の指定がないなら、クリックの音声鳴らさない            if( app.sounds.sentenceSound[i] === '' ){                $li.css({                        'left':isFinite(pos[0]) ? pos[0]-0 : pos[0],                        'top':isFinite(pos[1]) ? pos[1]-0 : pos[1]                    })            }else{                $li.data('sound', app.sounds.sentenceSound[i])                    .click(function(){                        soundPiece($(this));                    })                    .css({                        'left':isFinite(pos[0]) ? pos[0]-0 : pos[0],                        'top':isFinite(pos[1]) ? pos[1]-0 : pos[1]                    })                    .addClass('hasSound')            }                        $piece.append($li);        }        // 左側のアイコンクリック時の処理        $('#mainContent .sf-all').click(function(){            var $this = $(this);            // >ボタンの時            if( $this.hasClass('fa-chevron-right') ){                var soundUnits = function($hasSounds, index){                    var $li = $hasSounds.eq(index);                    // 最後であれば終了                    if($li.length === 0){                        // ボタン切り替え                        $this.addClass('fa-chevron-right').removeClass('fa-stop');                        return;                    }                    $li.addClass('hover');                    soundPiece($li).done(function(){                        // 音声終了したら次の音を再生                        soundUnits($hasSounds, index+1);                    })                }                // 一つ目を再生                soundUnits($('#mainContent .sf-piece li.hasSound'), 0);                // ボタン切り替え                $this.removeClass('fa-chevron-right').addClass('fa-stop');            }            // ■ボタンの時            else{                soundRotation();                $('.hasSound.hover').removeClass('hover');                $(this).addClass('fa-chevron-right').removeClass('fa-stop');            }        })    }    // DICTATION & REP用の関数    function funcDictationRep(json, app){        console.dir(app);        var templateTr = '<tr><td class="di-questions_number"><span class="di-questions_icon"></span></td><td class="di-questions_text"></td><td class="di-check"></td></tr>';        // 問題文の挿入処理        var $table = $('.di-questions_table');        var $tempTable = $('<tbody></tbody>')        for( var i = 0, len = app.sentences.length; i < len; i++ ){            var $tr = $(templateTr);            var q_text = app.sentences[i];            q_text = q_text.replace(/{/g, '<span class="di-questions_secret">');            q_text = q_text.replace(/}/g, '</span><input type="text" class="di-questions_answer hide">');            $tr.find('.di-questions_icon').html(i+1);            $tr.find('.di-questions_text').html(q_text);            if( i >= 5 ){                $tr.addClass('hide');            }            $tr.find('.di-questions_secret').each(function(index){                var answerLen = $(this).text().length;                $tr.find('.di-questions_answer').eq(index).attr('maxlength', answerLen);            });            // テーブルに挿入            $tempTable.append($tr.data('hash', app.hashAnswers[i]).data('sound', app.sounds.sentenceSound[i]));        }        $table.append( $tempTable );        // アイコンクリック時の処理        $('.di-questions_icon').click(function(){            $tr = $(this).closest('tr');            soundRotation($tr.data('sound'));            // 正解してなければテキストボックス表示            if(!$tr.hasClass('correct')){                // テキストボックスの長さ指定                $tr.find('.di-questions_answer:hidden').each(function(){                    $(this).width( $(this).prev('.di-questions_secret').width() + 30 );                });                $('.di-questions_secret').removeClass('hide');                $('.di-questions_answer').addClass('hide');                                $tr.find('.di-questions_secret').addClass('hide');                $tr.find('.di-questions_answer').removeClass('hide').eq(0).focus();            }        });        // 正解時の表示画像        var sealImage = new Image();        sealImage.src = app.sealImage;        sealWidth = 20;        var sealTag = '<img src="' + json['materialPath'] + app.sealImage + '" class="di-questions_seal-image" width="' + sealWidth + '">';        // テキストボックスエンターキー        $('.di-questions_answer').keydown(function(e){            // エンターキーなら            if( e.keyCode === 13){                var $tr = $(this).closest('tr');                var hashKey = $tr.data('hash');                var answerTxt = '';                $tr.find('.di-questions_answer').each(function(){                    answerTxt += $(this).val();                });                var answerHash = getHashCode(answerTxt);                // 正解ならば                if( answerHash === hashKey ){                    soundRotation(app.sounds.hitSound);                    var sealCnt = 1;                    var $question_answer = $tr.find('.di-questions_answer');                    var $questions_secret = $tr.find('.di-questions_secret');                    $tr.addClass('correct');                    $questions_secret.removeClass('hide');                    $question_answer.addClass('hide')                        .prop({ 'disabled':true,readonly:true });                    $tr.find('.di-check').html('<i class="fa fa-check"></i>');                                        for(var i = 0, len = $questions_secret.length; i < len; i++){                        var answerWidth = $questions_secret.eq(i).width();                        var $questions_secret_i = $questions_secret.eq(i);                        $questions_secret_i.text('');                        // 画像を表示                        for(sealCnt = 1; sealCnt * sealWidth < answerWidth; sealCnt++){                            $questions_secret_i.append(sealTag);                        }                        $questions_secret_i.append(sealTag);                        $questions_secret_i.append('<span class="di-questions_seal-text hide">' + $question_answer.eq(i).val() + '</span>');                    }                    // 全問正解時                    if( $('.di-questions_table .fa-check').length === $('.di-check').length ){                        $('.di-greatjob').removeClass('hide');                        soundRotation(app.sounds.clapSound);                    }                }else{                    soundRotation(app.sounds.mistakeSound);                    $tr.find('.di-questions_secret').removeClass('hide');                    $tr.find('.di-questions_answer').addClass('hide');                }            }        });        // 問題切り替えボタンクリック時の処理        $('.di-switch_btn').click(function(){            $('.di-questions_table tr').toggleClass('hide');            $('.di-switch span, .di-switch sub').toggleClass('hide');        });        // チェックマークをおした時の処理        var onDown = ('onpointerdown' in window) ? 'pointerdown' : (('onmousedown' in window) ? 'mousedown' : 'touchstart');        var onUp = ('onpointerup' in window) ? 'pointerup' : (('onmouseup' in window) ? 'mouseup' : 'touchend');        var onOut = ('onpointerup' in window) ? 'pointerout' : (('onmouseup' in window) ? 'mouseout' : 'touchend');        var flgDown = false;        // チェックダウン        $('.di-check').on(onDown, '.fa-check', function(){            if(!flgDown){                flgDown = true;                soundRotation(app.sounds.answerShowSound);                var $tr = $(this).closest('tr');                $tr.find('.di-questions_seal-image').addClass('hide');                $tr.find('.di-questions_seal-text').removeClass('hide');            }        });        // チェックアップ        $('.di-check').on(onUp + ' ' + onOut, '.fa-check', function(){            if(flgDown){                flgDown = false;                var $tr = $(this).closest('tr');                $tr.find('.di-questions_seal-image').removeClass('hide');                $tr.find('.di-questions_seal-text').addClass('hide');            }        });    }    // VOCABULARUY用の関数    function funcVocabulary(app){        var MAX_TIME = 30000; // 30秒        var templateTr = '<tr><td class="vo-answer"><div class="vo-answer_wrap"><span class="vo-answer_num hide circle-letter"></span><span class="vo-answer_word hide"></span></div></td><td class="vo-japanese"><span class="vo-japanese_word"></span></td></tr>';        var timer, startTime, soundTime;        var mistakeCnt = 0; // 失敗カウント        var answerCnt = 0; // 回答済みカウント        var voScore = 0; // スコア        var flgPlaying = false; // テスト中        // 結果更新        var updateResult = function(score){            $('.vo-result').css('visibility', 'visible');            var countdown = $('.vo-countdown').text() - 0;            // タイムアウト            if( countdown > (MAX_TIME / 1000) ){                $('.vo-result_txt').html('Sorry Time Out!<br>Try Again!');                soundRotation(app.sounds.timeoutSound);            }            // プラチナ            else if( score >= 100 ){                $('.vo-result_txt').html('<img src="' + app.medalImage.platinum + '">');                $('.contentProblem').css('background-image', 'url(' + app.plattinumBgImage + ')')                soundRotation(app.sounds.platinumSound);            }            // 金            else if( score >= 90 ){                $('.vo-result_txt').html('<img src="' + app.medalImage.gold + '">');                soundRotation(app.sounds.goldSound);            }            // 銀            else if(score >= 80){                $('.vo-result_txt').html('<img src="' + app.medalImage.silver + '">');                soundRotation(app.sounds.silverSound);            }            // 銅            else if(score >= 70){                $('.vo-result_txt').html('<img src="' + app.medalImage.bronze + '">');                soundRotation(app.sounds.bronzeSound);            }            // Try Again!            else{                $('.vo-result_txt').html('TRY AGAIN!');            }            $('.vo-result_score').text(Math.floor(score) + ' 点');        }        // タイマー        var voStep = function(){            if(!flgPlaying) return;            var timestamp = (new Date()).getTime();            // 最初の起動なら、スタート変数にタイムスタンプ代入            if(!startTime){                startTime = timestamp;            }            var progress = timestamp - startTime;            // スタートして30秒以内なら            if(progress < MAX_TIME && flgPlaying){                // バーの長さを変える                $('.vo-countbar_chart').css('width', (progress/MAX_TIME*100) + '%' );                // 前回の音声を鳴らして数秒たっているなら、再度音声を鳴らす                if( timestamp - soundTime > 3000 ){                    soundWord();                }            }            // カウントダウン            $('.vo-countdown').text(Math.floor(progress / 1000));            // タイムアウト処理            if(progress >= (MAX_TIME + 1000) && flgPlaying){                $('.vo-countbar_chart').css('width', '100%');                flgPlaying = false;                updateResult(voScore);                return;            }            // 次の処理を行う            timer = requestAnimationFrame(voStep);        }        // 英単語の音声を鳴らす処理        // isNext:次の音声を鳴らす        var soundWord = function(isNext){            var $table = $('.vo-selection_table');            var current = $table.data('current');            if(isNext){                $table.data('current', ++current);            }            soundRotation($table.data('wordSound')[$table.data('soundArr')[current]-1]);            soundTime = (new Date()).getTime();        }        // スタートボタンクリック時の処理        $('.vo-startbtn').click(function(){            var $tbody = $('<tbody></tbody>');            var listLen = app.wordJp.length;            var listArr = getRandValues({size:listLen,max:listLen});            var soundArr = getRandValues({size:listLen,max:listLen});            var $this = $(this);            if( $this.data('kind') === 'reset' ){                $this.data('kind', '');                var $table = $('.vo-selection_table');                $table.html('');                $('.contentProblem').css('background-image', '');                flgPlaying = false;                soundRotation(app.sounds.introSound).done(function(){                    voScore = 0;                    $this.data('kind', 'start');                    // リセットボタン押下時                    $('.vo-startTxt').text('START!').attr('data-kind', 'start');                    $('.vo-result').css('visibility', '');                                        // 問題文作成                    for(var i = 0, len = listArr.length; i < len; i++){                        var rand = listArr[i] - 1;                        var $tr = $(templateTr);                        $tr.data('sound', listArr[i]);                        $tr.find('.vo-answer_num').text(i+1);                        $tr.find('.vo-answer_word').text( app.wordEn[rand] );                        $tr.find('.vo-japanese_word').text( app.wordJp[rand] );                        $tbody.append($tr);                    }                    $table.append($tbody);                })            }else if($this.data('kind') === 'start'){                // スタートボタン押下時                $('.vo-startTxt').text('RESET!').attr('data-kind', 'reset');                $this.data('kind', 'reset');                var $table = $('.vo-selection_table');                // 音声の設定                $table.data('soundArr', soundArr);                $table.data('current', 0);                $table.data('wordSound', app.sounds.wordSound);                                flgPlaying = true;                startTime = 0;                requestAnimationFrame(voStep);                soundWord();                                // 失敗カウントリセット                mistakeCnt = 0;                answerCnt = 0;            }        });        // 単語クリック時の処理        $('.vo-selection_table').on('click', '.vo-japanese_word', function(){            if(!flgPlaying) return; // テスト中でなければ何もしない            var $this = $(this);            var $table = $('.vo-selection_table');            var $tr = $this.closest('tr');            // クリックした単語と現在の音声が同じならば            if($tr.data('sound') === $table.data('soundArr')[$table.data('current')]){                $tr.find('.hide').removeClass('hide');                if(mistakeCnt){                    $tr.addClass('vo-mistake');                }                // スコア加算                if(mistakeCnt === 0){                    voScore += 10;                }else if(mistakeCnt === 1){                    voScore += 5;                }                mistakeCnt = 0;                answerCnt++;                                // 全問解答したとき                if( answerCnt === $table.data('soundArr').length ){                    cancelAnimationFrame(timer); // アニメーション停止                    var countdown = $('.vo-countdown').text() - 0;                    // 15秒以内なら                    if( countdown <= 15 ){                        voScore *= 1;                    }                    // 20秒以内なら                    else if( countdown <= 20 ){                        voScore *= 0.9;                    }                    // 25秒以内なら                    else if( countdown <= 25 ){                        voScore *= 0.8;                    }                    // 30秒以内なら                    else if( countdown <= 30 ){                        voScore *= 0.7;                    }                    updateResult(voScore);                    flgPlaying = false;                }else{                    soundWord(true);                }            }else{                mistakeCnt++;                soundRotation(app.sounds.mistakeSound, true);            }        });        // 英単語クリック時の処理        $('.vo-selection_table').on('click', '.vo-answer_wrap', function(){            soundRotation( app.sounds.wordSound[$(this).closest('tr').data('sound')-1] );        })        // リセットボタンクリック        $('.vo-startbtn').click();    }    // TOEIC TEST Part1用の関数    function funcToeicPart1(json, app){        console.dir(app);        var $img1 = $('.p1-imageQ_img').eq(0).html('<img src="' + json.materialPath + app.pic1Img + '">');        var $img2 = $('.p1-imageQ_img').eq(1).html('<img src="' + json.materialPath + app.pic2Img + '">');        var $img1Btn = $('.p1-imageQ_btn').eq(0).find('.circle_alpha');        var $img2Btn = $('.p1-imageQ_btn').eq(1).find('.circle_alpha');        var $helpBtn = $('#lightbox-panel .circle_alpha');        // 画像１の音声セット        $('.p1-all').eq(0).data('sound', app.sounds.pic1Sound[0]);        for(var i = 0, len = $img1Btn.length; i < len; i++){            $img1Btn.eq(i).data('sound', app.sounds.pic1Sound[i+1])            .click(function(){	            	$('.p1-imageQ_btn span').removeClass('hover');					$(this).addClass('hover');                    soundPiece($(this));                });            $helpBtn.eq(i).data('sound', app.sounds.pic1Sound[i+1])            .click(function(){	            	$('.p1-imageQ_btn span').removeClass('hover');					$(this).addClass('hover');                    soundPiece($(this));                });        }        // 画像2の音声セット        $('.p1-all').eq(1).data('sound', app.sounds.pic2Sound[0]);        for(var i = 0, len = $img2Btn.length; i < len; i++){            $img2Btn.eq(i).data('sound', app.sounds.pic2Sound[i+1])            .click(function(){	            	$('.p1-imageQ_btn span').removeClass('hover');					$(this).addClass('hover');                    soundPiece($(this));                });        }                // 左側のアイコン・ボタンクリック時の処理        $('#mainContent .p1-all').click(function(){            var $this = $(this);            $('.p1-imageQ_btn span').removeClass('hover');            // >ボタン            if($this.hasClass('fa-chevron-right')){                var soundUnits = function($span){                    // 最後であれば終了                    if($span.length === 0){                        // アイコン切り替え                        $this.addClass('fa-chevron-right').removeClass('fa-stop');                        return;                    }                    $span.addClass('hover');                    soundPiece($span).done(function(){                        // 音声終了したら次の音を再生                        soundUnits($span.next());                    })                }                // 一つ目を再生                soundPiece($this).done(function(){                    soundUnits($this.next());                });                // アイコン切り替え                $(this).removeClass('fa-chevron-right').addClass('fa-stop');                            }else{                soundRotation();                $this.nextAll().removeClass('hover');                // アイコン切り替え                $(this).addClass('fa-chevron-right').removeClass('fa-stop');            }        })    }    // TOEIC TEST Part2用の関数    function funcToeicPart2(json, app){        console.dir(app);        var questionArr = ["question3Sound", "question4Sound", "question5Sound", "question6Sound", "question7Sound", "question8Sound"];        // 音声のセット        $('.p2-question tbody tr').each(function(i){            var $this = $(this);            // 左のアイコン            if(i === 0){                $this.find('.p2-all').data('sound', app.sounds.allFirstSound).click(function(){                    $('.countbar').hide();                    if($(this).hasClass('fa-chevron-right')){                        $('.p2-question').addClass('playing');                        var $circle_number = $this.closest('table').find('.circle_number');                        $circle_number.eq(0).data('onClick')()                            .then(function(){                                return $circle_number.eq(1).data('onClick')();                            })                            .then(function(){                                return $circle_number.eq(2).data('onClick')();                            })                            .then(function(){                                return $circle_number.eq(3).data('onClick')();                            })                            .then(function(){                                return $circle_number.eq(4).data('onClick')();                            })                            .then(function(){                                return $circle_number.eq(5).data('onClick')();                            })                            .then(function(){                                $('.p2-all').addClass('fa-arrow-left').removeClass('fa-stop');                                $('.p2-endMsg').show();                            });                        $(this).addClass('fa-stop').removeClass('fa-chevron-right');                    }else{                        $('.p2-endMsg').hide();                        $('.p2-question').removeClass('playing');                        soundRotation();                        $('.circle_alpha.hover').removeClass('hover');                        $('tr.current').removeClass('current');                        $('.countbar').hide();                        $('.countbar_container').stop();                        // ストップボタン                        $(this).removeClass('fa-stop fa-arrow-left').addClass('fa-chevron-right');                    }                });            }            // 番号ボタン            $this.find('.circle_number').data('sound', app.sounds[questionArr[i]][0]).data('onClick', function(){                var d = new $.Deferred;                var $numBtn = $this.find('.circle_number');                var $tr = $numBtn.closest('tr');				// 再生中のスタイルを解除                $('tr.current').removeClass('current');                $('.circle_alpha.hover').removeClass('hover');                 // 新しく再生する番号にスタイルを設定                $tr.addClass('current');                $('.p2-question').addClass('playing');				                var soundUnits = function($span){                    // 最後であれば終了                    if($span.length === 0){                        $tr.find('.countbar').data('onCountdown')().done(function(){                            $tr.removeClass('current');                            d.resolve();                        });                        return;                    }                    $span.addClass('hover');                    soundPiece($span).done(function(){                        // 音声終了したら次の音を再生                        soundUnits($span.next());                    })                }                // 一つ目を再生                soundPiece($numBtn).done(function(){                    console.dir($tr);                    soundUnits($tr.find('.circle_alpha').eq(0));                });                $('.p2-all').addClass('fa-stop').removeClass('fa-chevron-right');                return d.promise();            }).click(function(){                $(this).data('onClick')();            });;            // アルファベットボタン            $this.find('.circle_alpha').each(function(j){                $(this).data('sound', app.sounds[questionArr[i]][j+1])                .click(function(){                        if( $('.p2-question').hasClass('playing') ){                            // 再生中なら何もしない                            return;                        }                        soundPiece($(this));                    });            })        });        $('.countbar').hide();            }    // TOEIC TEST Part3用の関数    function funcToeicPart3(json, app){        var $soundButton = $('.p3-soundbutton');        var allDuration = 0;        // ボタンの設定        for(var i = 0, len = app.sounds.speechSound.length; i < len; i++){            var sound = app.sounds.speechSound[i];            var sex = app.soundSex[i];            var $span = $('<span class="circle-letter circle-big"></span>');            // 男女の設定            if( sex === 'W' ){                $span.addClass('circle_woman').text('W');            }else{                $span.addClass('circle_man').text('M');            }            // 音声の長さの取得            (function(){                                allDuration += (audioObj[sound].duration*1000);                $('.p3-countbar').data('time', allDuration);            })();            // ボタンクリック時の処理            $span.data('sound', sound).click(function(){                soundPiece($(this));            });            // HTMLの設定            $soundButton.append($span);        }        // 左側の＞クリック時の処理        $('#mainContent .p3-all').data('sound', app.sounds.directionSound).click(function(){            var $this = $(this);            if( $this.hasClass('fa-chevron-right') ){                $('.p3-question > p').removeClass('visible');                $('.p3-descriptive').show();                var soundUnits = function($span){                    // 最後であれば問題文表示                    if($span.length === 0){                        $('.p3-question_countbar').addClass('visible');                        $('.p3-question_unit').eq(0).addClass('visible');                        soundPiece($('.p3-question_unit').eq(0))                        .then(function(){                            return $('.p3-question_countbar').data('onCountdown')();                        })                        .then(function(){                            $('.p3-question_unit').eq(0).removeClass('visible');                            $('.p3-question_unit').eq(1).addClass('visible');                            return soundPiece($('.p3-question_unit').eq(1))                        })                        .then(function(){                            return $('.p3-question_countbar').data('onCountdown')();                        })                        .then(function(){                            $('.p3-question_unit').eq(1).removeClass('visible');                            $('.p3-question_unit').eq(2).addClass('visible');                            return soundPiece($('.p3-question_unit').eq(2))                        })                        .then(function(){                            return $('.p3-question_countbar').data('onCountdown')();                        })                        .then(function(){                            $('.p3-question_unit').eq(2).removeClass('visible');                            $('.p3-question_end').addClass('visible');                            $('.fa-stop').removeClass('fa-stop').addClass('fa-arrow-left');                        });                        return;                    }                    $span.addClass('hover');                    soundPiece($span).done(function(){                        // 音声終了したら次の音を再生                        soundUnits($span.next());                    })                }                // 一つ目を再生                soundPiece($this).done(function(){                    $this.addClass('fa-stop').removeClass('fa-chevron-right');                    $('.p3-countbar').data('onCountdown')();                    soundUnits($this.next());                });            }            // 停止ボタン            else{                soundRotation();                $('.p3-question .visible').removeClass('visible');                $('.p3-descriptive').hide();                $('.circle-letter.hover').removeClass('hover');                $('.p3-countbar').hide();                $('.countbar_container').stop();                $this.removeClass('fa-stop fa-arrow-left').addClass('fa-chevron-right');            }        })        $('.p3-countbar').hide();        // 問題文の設定        $('.p3-question_unit').eq(0).text( app.questionText[0] ).data('sound', app.sounds.questionSound[0]);        $('.p3-question_unit').eq(1).text( app.questionText[1] ).data('sound', app.sounds.questionSound[1]);        $('.p3-question_unit').eq(2).text( app.questionText[2] ).data('sound', app.sounds.questionSound[2]);    }    // TOEIC TEST Part4用の関数    function funcToeicPart4(json, app){        var p4Timer;        var second = 0;        var face_interval = null;        // 金、銀、銅の秒数設定        var p4time = {            "gold":60*app.words/app.wpm.gold,            "silver":60*app.words/app.wpm.silver,            "bronze":60*app.words/app.wpm.bronze        };        var changeModeBtn = function(mode){            $('.mode-button').text( mode.toUpperCase() );            $('.mode-button').attr( 'data-kind', mode.toLowerCase() );        }        // メインメニューの画像セット        $('.p4-menu_chunk').append('<img src="' + json.materialPath + app.categoryImage.chunk + '" class="p4-menu_image">');        $('.p4-menu_shadowing').append('<img src="' + json.materialPath + app.categoryImage.shadowing + '" class="p4-menu_image">');        $('.p4-menu_repeating').append('<img src="' + json.materialPath + app.categoryImage.repeating + '" class="p4-menu_image">');        $('.p4-menu_time').append('<img src="' + json.materialPath + app.categoryImage.time + '" class="p4-menu_image">');        // アイコンクリック時の設定        $('.letter-icon').click(function(){            $('.p4-menu').addClass('hide');            $('.p4-main').removeClass('hide')                .attr('data-mode', $(this).data('mode'));                        // 四角の位置設定            var tail_pos = $('.p4-text .p4-tail').position();            $('.p4-foreground .p4-tail').css({                'left':tail_pos.left,                'top':tail_pos.top            });            // 現在のボタンにcurrentクラス追加            $('.p4-submenu .letter-icon[data-mode="'+ $(this).data('mode') +'"]').addClass('current')                .siblings().removeClass('current');            var mode = $(this).data('mode');            soundRotation();            changeModeBtn('start');            $('.mode-button').removeClass('invisible');            $('.p4-text').removeClass('hoverHide');            $('.p4-foreground').addClass('hide').removeClass('hoverHide');            $('.p4-chunk').removeClass('hidn current transparent');            $('.p4-question').addClass('hide');            $('.p4-face, .p4-time').addClass('hide');            clearTimeout(p4Timer);            if(mode === 'chunk'){                $('.p4-foreground').removeClass('hide');                $('.p4-chunk').addClass('hidn');            }else if(mode === 'shadowing'){                $('.p4-foreground').addClass('hide');            }else if(mode === 'repeating'){                $('.p4-foreground').addClass('hide');            }else if(mode === 'time'){                $('.p4-foreground').removeClass('hide');                $('.p4-chunk').addClass('hidn');                $('.p4-face, .p4-time').removeClass('hide gold silver bronze tryagain');            }            $('.p4-foreground_logo').html('<img src="' + json.materialPath + app.categoryImage[mode] + '">');        });        // YESボタン        $('.p4-continue_yes').click(function(){            $('.p4-question_continue').addClass('hide');            $('.p4-question_problem').removeClass('hide');            $('.p4-question_text:eq(1), .p4-question_countbar').removeClass('visible')            $('.p4-question_text:eq(0)').addClass('visible');            console.log('before soundpiece');            soundPiece($('.p4-question_text').eq(0))            .then(function(){                $('.p4-question_countbar').eq(0).addClass('visible');                return $('.p4-question_countbar > .countbar').eq(0).data('onCountdown')();            })            .then(function(){                $('.p4-question_countbar').eq(0).removeClass('visible');                return soundPiece($('.p4-question_text').eq(1).addClass('visible'));            })            .then(function(){                $('.p4-question_countbar').eq(1).addClass('visible');                return $('.p4-question_countbar > .countbar').eq(1).addClass('visible').data('onCountdown')();            })            .then(function(){                $('.p4-question_countbar').eq(1).removeClass('visible');                return soundPiece($('.p4-question_text').eq(2).addClass('visible'));            })            .then(function(){                $('.p4-question_countbar').eq(2).addClass('visible');                return $('.p4-question_countbar > .countbar').eq(2).addClass('visible').data('onCountdown')();            })            .then(function(){                $('.p4-submenu .current').click();            });        });        // NOボタン        $('.p4-continue_no').click(function(){            $('.p4-submenu .letter-icon.current').click();        });        // 右下のSTARTボタン        $('.mode-button').click(function(){            var kind = $(this).attr('data-kind');            var mode = $('.p4-main').attr('data-mode');            if(mode === 'chunk'){                if(kind === 'start' || kind === 'next'){                    $('.p4-foreground').addClass('hide');                    // 最初なら                    if( $('.p4-chunk.current').length === 0 ){                        soundPiece($('.p4-chunk').eq(0).removeClass('hidn').addClass('current'));                        changeModeBtn('next');                    }else{                        var $cur = $('.p4-chunk.current').removeClass('current');                        var $next = $cur.next();                        // 最後なら                        if($next.hasClass('p4-tail')){                            changeModeBtn('again');                        }else{                            soundPiece($next.removeClass('hidn').addClass('current'));                        }                    }                }else if(kind === 'again'){                    $('.p4-submenu .letter-icon.current').click();                }            }else if(mode === 'shadowing'){                if(kind === 'start'){                    $('.p4-text').addClass('hoverHide');                    $('.p4-foreground').removeClass('hide').addClass('hoverHide');                    var soundUnits = function($item){                        $('.p4-chunk').removeClass('transparent');                        $item.addClass('transparent');                        // 最後であれば終了                        if($item.length === 0){                            $('.mode-button').addClass('invisible');                            $('.p4-question').removeClass('hide');                            $('.p4-question_continue').removeClass('hide');                            $('.p4-question_problem').addClass('hide');                            return;                        }                        $item.addClass('hover');                        soundPiece($item).done(function(){                            // 音声終了したら次の音を再生                            soundUnits($item.next('.p4-chunk'));                        })                    }                    // 一つ目を再生                    soundUnits($('.p4-chunk').eq(0));                    changeModeBtn('stop');                }else if(kind === 'stop'){                    $('.p4-submenu .letter-icon.current').click();                    changeModeBtn('start');                }            }else if(mode === 'repeating'){                if(kind === 'start'){                    $('.p4-text').addClass('hoverHide');                    $('.p4-foreground').removeClass('hide').addClass('hoverHide');                    var soundUnits = function($item){                        $('.p4-chunk').removeClass('current');                        $item.addClass('current');                        // 最後であれば終了                        if($item.length === 0){                            $('.p4-text').removeClass('hoverHide');                            $('.p4-foreground').addClass('hide').removeClass('hoverHide');                            return;                        }                        $item.addClass('hover');                        soundPiece($item).done(function(){                            // 音声終了したら3秒まってから次の音を再生                            p4Timer = setTimeout(function(){                                // 音声終了したら次の音を再生                                soundUnits($item.next('.p4-chunk'));                            }, 3000);                        })                    }                    // 一つ目を再生                    soundUnits($('.p4-chunk').eq(0));                    changeModeBtn('stop');                }else if(kind === 'stop'){                    $('.p4-submenu .letter-icon.current').click();                    changeModeBtn('start');                }            }else if(mode === 'time'){                var startTime = 0;                if(kind === 'start'){                    startTime = (new Date()).getTime();                    $('.p4-time').text('00:00');                    second = 0;                    $('.p4-foreground').addClass('hide');                    var $cur = $('.p4-chunk').eq(0);                    $cur.removeClass('hidn');                    changeModeBtn('next');                    // 時間計測                    p4Timer = setTimeout(function(){                        second = parseInt(((new Date()).getTime() - startTime)/1000);                        var m = ('00' + parseInt(second/60)).slice(-2);                        var s = ('00' + parseInt(second%60)).slice(-2);                        var time = m + ':' + s;                        // 経過時間を設定                        if( $('.p4-time').text() !== time ){                            $('.p4-time').text(time);                        }                        p4Timer = setTimeout(arguments.callee, 100);                    }, 100);                }else if(kind === 'next'){                    var $cur = $('.p4-chunk:not(.hidn)');                                        // 最後なら                    if( $('.p4-chunk:not(.hidn)').hasClass('last') ){                        $('.p4-chunk').removeClass('hidn');                        changeModeBtn('again');                        clearTimeout(p4Timer);                        clearInterval(face_interval);                        // gold                        if(second <= p4time.gold){                            $('.p4-face').addClass('gold');                            face_interval = setInterval( function(){	                            if( $('#mainContent .p4-face.gold').css("background-image").indexOf("-off") < 0 ) {		                        	$('#mainContent .p4-face.gold').css("background-image", "url(../image/gold-off.png)");								} else {									$('#mainContent .p4-face.gold').css("background-image", "url(../image/gold-on.png)");								}							}, 1000);							soundRotation(app.sounds.goldSound);                        // silver                        }else if(second <= p4time.silver){                            $('.p4-face').addClass('silver');                            face_interval = setInterval( function(){	                            if( $('#mainContent .p4-face.silver').css("background-image").indexOf("-off") < 0 ) {		                        	$('#mainContent .p4-face.silver').css("background-image", "url(../image/silver-off.png)");								} else {									$('#mainContent .p4-face.silver').css("background-image", "url(../image/silver-on.png)");								}							}, 1000);                            soundRotation(app.sounds.silverSound);                        // bronze                        }else if(second <= p4time.bronze){                            $('.p4-face').addClass('bronze');                            soundRotation(app.sounds.bronzeSound);                        }else{                            $('.p4-face').addClass('tryagain');                            soundRotation(app.sounds.tryagainSound);                        }                    }else{                        var $next = $cur.next();                        $cur.addClass('hidn');                        $next.removeClass('hidn');                    }                }else if(kind === 'again'){	                clearInterval(face_interval);	                $('.p4-face').removeClass('gold');	                $('.p4-face').removeClass('silver');	                $('.p4-face').removeClass('bronze');	                $('.p4-face').removeClass('tryagain');	                $('.p4-face').removeAttr("style");                    $('.p4-submenu .letter-icon.current').click();                }            }        })        var $sentence = $('.p4-text_sentence');        // 文章の設定        for(var i = 0, len = app.chunks.length; i < len; i++){            var $chunk = $('<span class="p4-chunk"></span>');            $chunk.text(app.chunks[i])                .data('sound', app.sounds.chunkSound[i])                .click(function(){                    soundPiece($(this));                });            // 最後のchunkならクラス追加            if(i === len-1){                $chunk.addClass('last');            }            $sentence.append($chunk);        }        $sentence.append('<span class="p4-tail"></span>');        // 問題の設定        $('.p4-question_text').eq(0).text('12. ' + app.questionText[0]).data('sound', app.sounds.questionSound[0]);        $('.p4-question_text').eq(1).text('13. ' + app.questionText[1]).data('sound', app.sounds.questionSound[1]);        $('.p4-question_text').eq(2).text('14. ' + app.questionText[2]).data('sound', app.sounds.questionSound[2]);    }    // HELP表示    $('.show-help').click(function(){        $("#BlackWindow, #lightbox-panel").fadeIn(300);    });    // HELP非表示    $(".close-panel, #BlackWindow").click(function(){          $("#BlackWindow, #lightbox-panel").fadeOut(300);/*フォードアウトの速度は数値を調整*/      });    // カウントバーの実装    $('.countbar').each(function(){        var $this = $(this);        var width = $this.data('width');        $this.width(width);        var height = $this.data('height');        $this.height(height);        $this.html('<div class="countbar_container"><div class="countbar_main"></div></div>');        $this.find('.countbar_main').width(width);        // カウントダウンイベントの実装        $this.data('onCountdown', function(){            var time = $this.data('time');            $this.show();            var d = new $.Deferred;            $this.find('.countbar_container').css('width', '100%').animate({                "width" : "0"            }, time, "linear", function(){                $this.hide();                d.resolve();            });            return d.promise();        });    });});